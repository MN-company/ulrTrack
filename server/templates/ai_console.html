{% extends "base.html" %}

{% block breadcrumb %}AI Analyst / Console{% endblock %}

{% block content %}
<div class="dashboard-grid" style="grid-template-columns: 1fr; height: calc(100vh - 180px);">
    <div class="card glass" style="display: flex; flex-direction: column; overflow: hidden; height: 100%;">
        <div class="card-header"
            style="border-bottom: 1px solid var(--border-subtle); padding-bottom: 1rem; margin-bottom: 0;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <i class="fa-solid fa-robot" style="font-size: 1.5rem; color: var(--accent-purple);"></i>
                <div>
                    <span class="card-title" style="display: block; color: var(--text-primary);">Gemini 2.0 Flash</span>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">Cybersecurity Intelligence
                        Analyst</span>
                </div>
            </div>
            <div class="badge badge-success">Online</div>
        </div>

        <!-- Chat Area -->
        <div id="chat-history"
            style="flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
            <div class="message system"
                style="align-self: flex-start; max-width: 80%; background: var(--border-subtle); padding: 1rem; border-radius: 12px 12px 12px 0;">
                <div style="font-weight: 600; font-size: 0.8rem; margin-bottom: 0.5rem; color: var(--accent-purple);">AI
                    Analyst</div>
                Systems online. I have access to your Lead database and Campaign logs. How can I assist with your
                investigation today?
            </div>
        </div>

        <!-- Input Area -->
        <div style="padding: 1.5rem; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border-subtle);">
            <div style="display: flex; gap: 1rem;">
                <input type="text" id="chat-input"
                    placeholder="Ask about specific IPs, Email patterns, or Dork suggestions..."
                    style="flex: 1; background: var(--bg-input); border: 1px solid var(--border-subtle); padding: 1rem; border-radius: 8px; color: var(--text-primary);">
                <button onclick="sendMessage()" class="btn btn-primary" style="padding: 0 1.5rem;">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                Try commands: <span class="text-mono">@email:example.com</span>, <span class="text-mono">analyze this
                    IP</span>
            </div>
        </div>
    </div>
</div>

<script>
    const chatHistory = document.getElementById('chat-history');
    const chatInput = document.getElementById('chat-input');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    chatInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        // User Bubble
        appendMessage('You', message, 'user');
        chatInput.value = '';

        // Typing Indicator
        const loadingId = appendMessage('AI Analyst', 'Analyzing database...', 'system', true);

        try {
            const response = await fetch("{{ url_for('dashboard.dashboard_ai.ai_console_send') }}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            // Remove loading
            document.getElementById(loadingId).remove();

            // AI Response
            appendMessage('AI Analyst', data.response, 'system');
        } catch (error) {
            console.error(error);
            document.getElementById(loadingId).innerText = "Error connecting to AI Network.";
        }
    }

    function appendMessage(sender, text, type, isLoading = false) {
        const div = document.createElement('div');
        const id = 'msg-' + Date.now();
        div.id = id;

        div.style.maxWidth = '80%';
        div.style.padding = '1rem';
        div.style.borderRadius = type === 'user' ? '12px 12px 0 12px' : '12px 12px 12px 0';
        div.style.alignSelf = type === 'user' ? 'flex-end' : 'flex-start';
        div.style.background = type === 'user' ? 'var(--accent-primary)' : 'var(--border-subtle)';
        div.style.color = 'var(--text-primary)';
        div.style.fontSize = '0.95rem';
        div.style.lineHeight = '1.6';

        // Enhanced Markdown parsing for AI
        let content = text;
        if (type === 'system') {
            content = text
                // Code blocks
                .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre style="background:#0d0d0d;padding:0.75rem;border-radius:6px;overflow-x:auto;font-family:monospace;font-size:0.85rem;margin:0.5rem 0;"><code>$2</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code style="background:#0d0d0d;padding:0.2rem 0.4rem;border-radius:4px;font-family:monospace;font-size:0.9em;">$1</code>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Headers
                .replace(/^### (.*?)$/gm, '<h4 style="color:var(--accent-primary);margin:0.75rem 0 0.5rem;">$1</h4>')
                .replace(/^## (.*?)$/gm, '<h3 style="color:var(--accent-primary);margin:0.75rem 0 0.5rem;">$1</h3>')
                .replace(/^# (.*?)$/gm, '<h2 style="color:var(--accent-primary);margin:0.75rem 0 0.5rem;">$1</h2>')
                // Bullet lists
                .replace(/^[â€¢\-\*] (.*?)$/gm, '<li style="margin-left:1rem;">$1</li>')
                // Numbered lists
                .replace(/^\d+\. (.*?)$/gm, '<li style="margin-left:1rem;">$1</li>')
                // Line breaks
                .replace(/\n/g, '<br>');
        }

        div.innerHTML = `
            <div style="font-weight: 600; font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">${sender}</div>
            <div>${content}</div>
        `;

        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return id;
    }
</script>
{% endblock %}