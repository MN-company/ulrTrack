{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2><i class="fas fa-brain"></i> AI Intelligence Center</h2>
    <div class="flex-row" style="gap: 10px;">
        <form action="/dashboard/ai/analyze_all" method="POST" style="display:inline;">

            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn"><i class="fas fa-robot"></i> Analyze All Pending</button>
        </form>
        <form action="/dashboard/ai/auto_tag_all" method="POST" style="display:inline;">

            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-outline"><i class="fas fa-tags"></i> Auto-Tag All</button>
        </form>
    </div>
</div>

<!-- Stats Cards -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
    <div class="card" style="text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent);">{{ analyzed_count }}</div>
        <div style="color: var(--text-sec);">Identities Analyzed</div>
    </div>
    <div class="card" style="text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; color: #FF9800;">{{ pending_count }}</div>
        <div style="color: var(--text-sec);">Pending Analysis</div>
    </div>
    <div class="card" style="text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700;">{{ total_leads }}</div>
        <div style="color: var(--text-sec);">Total Leads</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
    <!-- AI Analyses -->
    <div class="card">
        <h3><i class="fas fa-user-check"></i> Identity Inferences</h3>
        {% if ai_analyses %}
        <div style="max-height: 500px; overflow-y: auto;">
            {% for item in ai_analyses %}
            <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <a href="/dashboard/lead/{{ item.lead.id }}" class="text-accent"
                            style="font-size: 1.1rem; font-weight: 600;">
                            {{ item.lead.email }}
                        </a>
                        {% if item.lead.tags %}
                        <div style="margin-top: 5px;">
                            {% for tag in item.lead.tags.split(',') %}
                            <span class="badge badge-gray" style="font-size: 0.7rem;">{{ tag.strip() }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <form action="/dashboard/ai/auto_tag" method="POST">

                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="lead_id" value="{{ item.lead.id }}">
                        <button type="submit" class="btn-sm" title="Re-run AI Tagging"><i
                                class="fas fa-sync"></i></button>
                    </form>
                </div>
                <div
                    style="margin-top: 10px; background: rgba(0,255,157,0.05); padding: 10px; border-radius: 6px; white-space: pre-line; font-size: 0.85rem;">
                    {{ item.identity }}
                </div>
                {% if item.gaia_id %}
                <div style="margin-top: 8px; font-size: 0.8rem;">
                    <span style="color: var(--text-sec);">Gaia ID:</span>
                    <span class="mono text-accent">{{ item.gaia_id }}</span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #666;">
            No AI analyses yet. Click "Analyze All Pending" to start.
        </div>
        {% endif %}
    </div>

    <!-- Pending & Recent Devices -->
    <div>
        <!-- Pending Leads -->
        <div class="card" style="margin-bottom: 20px;">
            <h3><i class="fas fa-hourglass-half"></i> Pending Analysis</h3>
            {% if leads_pending %}
            <div style="max-height: 200px; overflow-y: auto;">
                {% for lead in leads_pending %}
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="font-size: 0.85rem;">{{ lead.email }}</span>
                    <form action="/dashboard/analyze_identity/{{ lead.id }}" method="POST">

                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn-sm" style="padding: 2px 8px;"><i
                                class="fas fa-play"></i></button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="color: #666; font-size: 0.9rem;">All leads analyzed! ðŸŽ‰</div>
            {% endif %}
        </div>

        <!-- Recent Device Analyses -->
        <div class="card">
            <h3><i class="fas fa-mobile-alt"></i> Recent Device AI</h3>
            <div style="max-height: 250px; overflow-y: auto;">
                {% for v in recent_visits %}
                <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem;">
                    <div style="color: var(--accent);">{{ v.ai_summary }}</div>
                    <div style="color: #666; font-size: 0.75rem;">
                        {{ v.ip_address }} â€¢ {{ v.timestamp.strftime('%m/%d %H:%M') }}
                    </div>
                </div>
                {% else %}
                <div style="color: #666;">No device analyses yet.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}