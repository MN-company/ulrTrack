<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULRTrack | Enterprise Intelligence</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700&family=JetBrains+Mono:wght@400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

    <!-- Global CSRF Protection -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <script>
        // Blazing Fast CSRF Injection for all Fetch requests
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            let [resource, config] = args;
            config = config || {};
            config.headers = config.headers || {};

            // Add CSRF token if not present
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            if (csrfToken && !config.headers['X-CSRFToken']) {
                config.headers['X-CSRFToken'] = csrfToken;
                config.headers['X-Requested-With'] = 'XMLHttpRequest';
            }

            return originalFetch(resource, config);
        };
    </script>

    {% block head %}{% endblock %}
</head>

<body>

    <div class="app-shell">
        {% if not hide_nav %}
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="brand">
                <i class="fa-solid fa-eye"></i>
                <span>OVERWATCH</span>
            </div>

            <nav class="nav-menu">
                <a href="{{ url_for('dashboard.dashboard_links.dashboard_home') }}"
                    class="nav-item {% if request.endpoint == 'dashboard.dashboard_links.dashboard_home' %}active{% endif %}">
                    <i class="fa-solid fa-gauge-high"></i>
                    Command Center
                </a>
                <a href="{{ url_for('dashboard.dashboard_leads.contacts') }}"
                    class="nav-item {% if 'leads' in request.endpoint %}active{% endif %}">
                    <i class="fa-solid fa-users-viewfinder"></i>
                    Targets (Leads)
                </a>
                <a href="{{ url_for('dashboard.dashboard_links.links') }}"
                    class="nav-item {% if 'links' in request.endpoint and 'home' not in request.endpoint %}active{% endif %}">
                    <i class="fa-solid fa-link"></i>
                    Campaigns (Links)
                </a>
                <a href="{{ url_for('dashboard.dashboard_ai.ai_console') }}"
                    class="nav-item {% if 'ai' in request.endpoint %}active{% endif %}">
                    <i class="fa-solid fa-brain"></i>
                    AI Analyst
                </a>
                <a href="{{ url_for('dashboard.dashboard_stats.global_timeline') }}"
                    class="nav-item {% if 'stats' in request.endpoint %}active{% endif %}">
                    <i class="fa-solid fa-chart-line"></i>
                    Global Intel
                </a>

                <div style="flex: 1"></div>

                <a href="{{ url_for('dashboard.dashboard_links.settings') }}"
                    class="nav-item {% if 'settings' in request.endpoint and 'security' not in request.endpoint %}active{% endif %}">
                    <i class="fa-solid fa-cog"></i>
                    Settings
                </a>
                <a href="{{ url_for('dashboard.dashboard_security.security_settings') }}"
                    class="nav-item {% if 'security' in request.endpoint %}active{% endif %}">
                    <i class="fa-solid fa-shield-halved"></i>
                    Security
                </a>
                <a href="{{ url_for('auth.logout') }}" class="nav-item" style="color: var(--accent-danger)">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    Logout
                </a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- TOP BAR -->
            <header class="top-bar">
                <div class="breadcrumbs">
                    System / <span>{% block breadcrumb %}Dashboard{% endblock %}</span>
                </div>

                <div class="top-actions">
                    <input type="text" class="search-bar" placeholder="Intelligence Search (Cmd+K)...">
                    <div
                        style="width: 32px; height: 32px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;">
                        {% if current_user.is_authenticated %}
                        {{ current_user.username[0].upper() }}
                        {% else %}
                        ?
                        {% endif %}
                    </div>
                </div>
            </header>
            {% else %}
            <!-- Standalone Layout (No Sidebar) -->
            <main class="main-content" style="margin-left: 0; width: 100%;">
                {% endif %}

                <!-- SCROLLABLE PAGE AREA -->
                <div class="page-scroll">
                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="badge badge-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'warning' }} mb-4"
                        style="display: block; width: fit-content;">
                        {{ message }}
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    {% block content %}{% endblock %}
                </div>
            </main>
    </div>

    {% block scripts %}{% endblock %}
</body>

</html>