{% extends "base.html" %}

{% block head %}
<style>
    /* Dashboard specific styles */
    .quick-create {
        display: grid;
        grid-template-columns: 3fr 1fr 1fr 1fr auto;
        gap: 10px;
        align-items: center;
    }

    .metrics {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
        padding: 20px;
        border-radius: 12px;
        border: var(--border);
    }

    .metric-val {
        font-size: 2rem;
        font-weight: 700;
        color: white;
    }

    .metric-label {
        font-size: 0.8rem;
        color: var(--text-sec);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
</style>
{% endblock %}

{% block content %}

<!-- Metrics Row -->
<div class="metrics">
    <div class="metric-card">
        <div class="metric-val mono">{{ total_links }}</div>
        <div class="metric-label">Active Links</div>
    </div>
    <div class="metric-card">
        <div class="metric-val mono text-accent">{{ total_clicks }}</div>
        <div class="metric-label">Total Traffic</div>
    </div>
    <div class="metric-card">
        <div class="metric-val mono" style="color: #ff5555;">{{ total_blocked }}</div>
        <div class="metric-label">Blocked / Suspicious</div>
    </div>
    <div class="metric-card">
        <div class="metric-val mono">ON</div>
        <div class="metric-label">System Status</div>
    </div>
</div>

<!-- Quick Create Bar -->
<div class="card">
    <form method="POST" action="/dashboard/create" class="quick-create">
        <input type="url" name="destination" placeholder="Paste Target URL here..." required>

        <input type="text" name="slug" placeholder="Slug (Opt)">

        <!-- Minimized Filters/Options -->
        <select name="block_bots">
            <option value="true">Block Bot: ON</option>
            <option value="false">Block Bot: OFF</option>
        </select>

        <select name="block_vpn">
            <option value="false">Block VPN: OFF</option>
            <option value="true">Block VPN: ON</option>
        </select>

        <div style="display:flex; gap:10px; align-items:center;">
            <label style="color:var(--text-sec); font-size:0.8rem;"><input type="checkbox" name="mask_url"> Mask</label>
            <label style="color:var(--text-sec); font-size:0.8rem;"><input type="checkbox" name="enable_captcha">
                Captcha</label>
            <label style="color:var(--text-sec); font-size:0.8rem;"><input type="checkbox" name="require_email">
                Gate</label>
        </div>

        <select name="email_policy" style="max-width:100px;">
            <option value="all">Allow All</option>
            <option value="certified">Certified (No Temp)</option>
            <option value="trackable">Trackable (Corp/ISP)</option>
        </select>

        <button type="submit" class="btn"><i class="fas fa-bolt"></i> CREATE</button>
    </form>
    <div
        style="margin-top: 10px; font-size: 0.8rem; color: var(--text-sec); display: flex; justify-content: space-between;">
        <span><i class="fas fa-info-circle"></i> Quick Mode uses default settings.</span>
        <a href="/dashboard/create_full" class="text-accent" style="font-weight: 600;">USE ADVANCED CREATOR &rarr;</a>
    </div>
</div>

<!-- Links Table -->
<div class="card" style="padding: 0;">
    <table>
        <thead>
            <tr>
                <th style="padding-left: 24px;">SLUG / DESTINATION</th>
                <th>FILTERS</th>
                <th>CLICKS</th>
                <th>OS / DEVICE</th>
                <th>CREATED</th>
                <th style="text-align: right; padding-right: 24px;">ACTIONS</th>
            </tr>
        </thead>
        <tbody>
            {% for link in links %}
            <tr>
                <td style="padding-left: 24px;">
                    <div style="font-weight: 600; font-size: 1rem;">
                        <span class="text-accent">/{{ link.slug }}</span>
                    </div>
                    {% if link.public_masked_url %}
                    <div style="font-size: 0.8rem; color: var(--accent); margin-bottom: 2px;">
                        <i class="fas fa-mask"></i> {{ link.public_masked_url }}
                    </div>
                    {% endif %}
                    <div
                        style="font-size: 0.8rem; color: var(--text-sec); max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ link.destination }}
                    </div>
                </td>
                <td>
                    {% if link.block_bots %}<span class="badge badge-green">BOT</span>{% endif %}
                    {% if link.block_vpn %}<span class="badge badge-green">VPN</span>{% endif %}
                    {% if link.block_adblock %}<span class="badge badge-green">ADB</span>{% endif %}
                    {% if link.enable_captcha %}<span class="badge badge-green">CAPTCHA</span>{% endif %}
                    {% if link.require_email %}<span class="badge badge-green">EMAIL</span>{% endif %}
                    {% if link.allowed_countries %}<span class="badge badge-warning">{{ link.allowed_countries
                        }}</span>{% endif %}
                </td>
                <td class="mono" style="font-size: 1.1rem;">{{ link.visits|length }}</td>
                <td class="mono" style="font-size: 0.9rem; color: var(--text-sec);">
                    {{ link.created_at.strftime('%Y-%m-%d') }}
                    <div style="font-size: 0.7rem; color: #888; margin-top:2px;">
                        {% set active_orgs = link.visits | selectattr("org") | map(attribute="org") | list %}
                        {% if active_orgs %}
                        <i class="fas fa-building"></i> {{ active_orgs[0] }}
                        {% endif %}
                    </div>
                </td>
                <td style="text-align: right; padding-right: 24px;">
                    <div class="flex-row" style="justify-content: flex-end;">
                        <button class="btn-outline btn-sm" onclick="copyLink('{{ server_url }}/{{ link.slug }}')"><i
                                class="fas fa-copy"></i></button>
                        <a href="/dashboard/qr_view/{{ link.slug }}" class="btn-outline btn-sm"><i
                                class="fas fa-qrcode"></i></a>
                        <a href="/dashboard/stats/{{ link.slug }}" class="btn-outline btn-sm"><i
                                class="fas fa-chart-line"></i></a>
                        <a href="/dashboard/edit/{{ link.id }}" class="btn-outline btn-sm"><i
                                class="fas fa-edit"></i></a>

                        <form method="POST" action="/dashboard/delete/{{ link.id }}"
                            onsubmit="return confirm('Delete?');" style="display:inline;">
                            <button type="submit" class="btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function copyLink(url) {
        navigator.clipboard.writeText(url).then(() => {
            alert("Copied: " + url);
        });
    }
</script>

{% endblock %}