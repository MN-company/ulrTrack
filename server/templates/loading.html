<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <title>Loading...</title>
    <style>
        body {
            background: #000;
            color: #000;
        }
    </style>
</head>

<body>
    <!-- 200 OK Stealth Redirect (No 30x headers) -->

    <!-- V9: AdBlock Bait Element -->
    <div class="ad-banner adsbox doubleclick" id="ads-bait"
        style="position:absolute; top:-999px; left:-999px; width:1px; height:1px;"></div>

    <script src="/static/js/metrics.js"></script>
    <script>
        var dest = "{{ destination }}";
        var visitId = "{{ visit_id }}";

        // V45: MurmurHash3 Implementation for Stable Canvas Fingerprinting
        function murmurhash3_32_gc(key, seed) {
            var remainder, bytes, h1, h1b, c1, c1b, c2, c2b, k1, i;
            remainder = key.length & 3; // key.length % 4
            bytes = key.length - remainder;
            h1 = seed;
            c1 = 0xcc9e2d51;
            c2 = 0x1b873593;
            i = 0;
            while (i < bytes) {
                k1 = ((key.charCodeAt(i) & 0xff)) |
                    ((key.charCodeAt(++i) & 0xff) << 8) |
                    ((key.charCodeAt(++i) & 0xff) << 16) |
                    ((key.charCodeAt(++i) & 0xff) << 24);
                ++i;
                k1 = ((((k1 & 0xffff) * c1) + ((((k1 >>> 16) * c1) & 0xffff) << 16))) & 0xffffffff;
                k1 = (k1 << 15) | (k1 >>> 17);
                k1 = ((((k1 & 0xffff) * c2) + ((((k1 >>> 16) * c2) & 0xffff) << 16))) & 0xffffffff;
                h1 ^= k1;
                h1 = (h1 << 13) | (h1 >>> 19);
                h1b = ((((h1 & 0xffff) * 5) + ((((h1 >>> 16) * 5) & 0xffff) << 16))) & 0xffffffff;
                h1 = (((h1b & 0xffff) + 0x6b64) + ((((h1b >>> 16) + 0xe654) & 0xffff) << 16));
            }
            k1 = 0;
            switch (remainder) {
                case 3: k1 ^= (key.charCodeAt(i + 2) & 0xff) << 16;
                case 2: k1 ^= (key.charCodeAt(i + 1) & 0xff) << 8;
                case 1: k1 ^= (key.charCodeAt(i) & 0xff);
                    k1 = (((k1 & 0xffff) * c1) + ((((k1 >>> 16) * c1) & 0xffff) << 16)) & 0xffffffff;
                    k1 = (k1 << 15) | (k1 >>> 17);
                    k1 = (((k1 & 0xffff) * c2) + ((((k1 >>> 16) * c2) & 0xffff) << 16)) & 0xffffffff;
                    h1 ^= k1;
            }
            h1 ^= key.length;
            h1 ^= h1 >>> 16;
            h1 = (((h1 & 0xffff) * 0x85ebca6b) + ((((h1 >>> 16) * 0x85ebca6b) & 0xffff) << 16)) & 0xffffffff;
            h1 ^= h1 >>> 13;
            h1 = ((((h1 & 0xffff) * 0xc2b2ae35) + ((((h1 >>> 16) * 0xc2b2ae35) & 0xffff) << 16))) & 0xffffffff;
            h1 ^= h1 >>> 16;
            return h1 >>> 0;
        }

        // --- V26: Optimized Speed & Fingerprinting ---
        function getCanvasHash() {
            try {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                // Complex drawing to provoke rendering differences
                ctx.textBaseline = "top";
                ctx.font = "14px 'Arial'";
                ctx.textBaseline = "alphabetic";
                ctx.fillStyle = "#f60";
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = "#069";
                ctx.fillText("ulrTrack_V45_Stable", 2, 15);
                ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
                ctx.fillText("Is this stable?", 4, 17);

                var dataURI = canvas.toDataURL();
                return murmurhash3_32_gc(dataURI, 256).toString(16);
            } catch (e) { return null; }
        }

        async function getStats() {
            var data = {
                cpu: navigator.hardwareConcurrency || '?',
                ram: navigator.deviceMemory || '?',
                gpu: 'Unknown',
                screen: (window.screen.width || 0) + 'x' + (window.screen.height || 0),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'
            };
            try {
                // Async WebGL to not block main thread
                var canvas = document.createElement('canvas');
                var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (gl) {
                    var debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        data.gpu = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                    }
                }
            } catch (e) { }
            return data;
        }

        // FIRE AND FORGET
        (async function () {
            // AdBlock Check (V42: Client-side detection)
            var adBlockEnabled = false;
            var bait = document.getElementById('ads-bait');
            // Check if bait blocked by CSS or removed
            if (!bait || bait.offsetHeight === 0 || bait.style.display === 'none') {
                adBlockEnabled = true;
            }

            var shouldBlock = "{{ 'true' if block_adblock else 'false' }}" === 'true';

            if (shouldBlock && adBlockEnabled) {
                // BLOCK USER: Stop redirect and show message
                document.body.innerHTML = '<div style="color:white; text-align:center; padding-top:50px; font-family:sans-serif;">' +
                    '<h1>AdBlock Detected</h1><p>Please disable your AdBlocker to continue.</p>' +
                    '<button onclick="location.reload()" style="padding:10px 20px; cursor:pointer;">I have disabled it</button></div>';

                // Log the block via beacon (optional)
                return; // STOP EXECUTION
            }

            // 1. Trigger Redirect ASAP (if not blocked)
            setTimeout(function () { window.location.href = dest; }, 50); // 50ms buffer

            // 2. Gather Data in background
            try {
                const stats = await getStats();
                const fpData = {
                    visit_id: visitId,
                    canvas_hash: getCanvasHash(),
                    webgl_renderer: stats.gpu,
                    cpu_cores: stats.cpu,
                    ram_gb: stats.ram,
                    screen_res: stats.screen,
                    timezone: stats.timezone
                };
                // Beacon is non-blocking
                navigator.sendBeacon("/api/beacon", JSON.stringify(fpData));

                // Session Detector Logic ...
                const probes = [
                    { name: 'Github', url: 'https://github.com/fluidicon.png' },
                    { name: 'Gitlab', url: 'https://gitlab.com/assets/favicon.png' }
                ];

                probes.forEach(p => {
                    const img = new Image();
                    img.onload = () => {
                        // navigator.sendBeacon...
                    };
                    img.src = p.url;
                });

            } catch (e) { }
        })();
    </script>

    <noscript>
        {% if allow_no_js %}
        <meta http-equiv="refresh" content="0;url={{ destination }}">
        <p>Redirecting... <a href="{{ destination }}">Click Here</a></p>
        {% else %}
        <!-- V9 Stealth: No Link for Bots/NoScript Users -->
        <p>Please enable JavaScript to proceed.</p>
        {% endif %}
    </noscript>
</body>

</html>