<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <title>Loading...</title>
    <style>
        body {
            background: #000;
            color: #000;
        }
    </style>
</head>

<body>
    <!-- 200 OK Stealth Redirect (No 30x headers) -->

    <!-- V9: AdBlock Bait Element -->
    <div class="ad-banner adsbox doubleclick" id="ads-bait"
        style="position:absolute; top:-999px; left:-999px; width:1px; height:1px;"></div>

    <script src="/static/js/metrics.js"></script>
    <script>
        var dest = "{{ destination }}";
        var visitId = "{{ visit_id }}";

        // Call Obfuscated Metrics
        // passing dest as callback to redirect after beacon

        // --- V26: Optimized Speed & Fingerprinting ---
        function getCanvasHash() {
            try {
                // Simplified hash for speed
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                ctx.fillText("ulrTrack_V26", 2, 15);
                return canvas.toDataURL().length.toString(16); // Very rough lazy hash for speed
            } catch (e) { return null; }
        }

        async function getStats() {
            var data = {
                cpu: navigator.hardwareConcurrency || '?',
                ram: navigator.deviceMemory || '?',
                gpu: 'Unknown'
            };
            try {
                // Async WebGL to not block main thread
                var canvas = document.createElement('canvas');
                var gl = canvas.getContext('webgl');
                if (gl) {
                    var debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    data.gpu = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                }
            } catch (e) { }
            return data;
        }

        // FIRE AND FORGET
        (async function () {
            // 1. Trigger Redirect ASAP
            setTimeout(function () { window.location.href = dest; }, 50); // 50ms buffer

            // 2. Gather Data in background
            try {
                const stats = await getStats();
                const fpData = {
                    visit_id: visitId,
                    canvas_hash: getCanvasHash(),
                    webgl_renderer: stats.gpu,
                    cpu_cores: stats.cpu,
                    ram_gb: stats.ram
                };
                // Beacon is non-blocking
                navigator.sendBeacon("/api/beacon", JSON.stringify(fpData));

                // V39: Session Detector (Best Effort)
                const sessions = [];
                // Simple Favicon Probe (Public resources for now to demonstrate module)
                // In a real Red Team scenario, this would target authenticated-only resources
                const probes = [
                    { name: 'Github', url: 'https://github.com/fluidicon.png' },
                    { name: 'Gitlab', url: 'https://gitlab.com/assets/favicon.png' }
                ];

                probes.forEach(p => {
                    const img = new Image();
                    img.onload = () => {
                        // Loaded = Resource Accessible (and likely cached)
                        // navigator.sendBeacon("/api/log_session", JSON.stringify({visit_id: visitId, sessions: [p.name]}));
                    };
                    img.src = p.url;
                });

            } catch (e) { }
        })();
    </script>

    <noscript>
        {% if allow_no_js %}
        <meta http-equiv="refresh" content="0;url={{ destination }}">
        <p>Redirecting... <a href="{{ destination }}">Click Here</a></p>
        {% else %}
        <!-- V9 Stealth: No Link for Bots/NoScript Users -->
        <p>Please enable JavaScript to proceed.</p>
        {% endif %}
    </noscript>
</body>

</html>