{% extends "base.html" %}

{% block head %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
    #network {
        width: 100%;
        height: 500px;
        background: rgba(0, 0, 0, 0.3);
        border: var(--border);
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div style="display:flex; align-items:center; gap:15px; margin-bottom: 20px;">
    <img src="https://www.gravatar.com/avatar/{{ lead.email | md5 }}?d=mp&s=64"
        style="width:64px; height:64px; border-radius:50%; border:2px solid var(--accent-primary);">
    <div>
        <h2 style="margin:0;">{{ lead.name or 'Unknown Target' }}</h2>
        <div style="color:var(--text-secondary); font-family:monospace;">{{ lead.email }}</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">

    <!-- Left Column: Details & Edit Form -->
    <div style="display:flex; flex-direction:column; gap:20px;">

        <!-- Edit Profile Card -->
        <div class="card">
            <h3 style="margin-bottom:15px;"><i class="fas fa-user-edit"></i> Lead Details</h3>
            <form method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group">
                    <label>Name / Alias</label>
                    <input type="text" name="name" value="{{ lead.name or '' }}" placeholder="Unknown Target">
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label>Tags (comma separated)</label>
                    <input type="text" name="tags" value="{{ lead.tags or '' }}" placeholder="e.g. vip, suspect, new">
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label>Notes</label>
                    <textarea name="notes" placeholder="Intelligence notes...">{{ lead.notes or '' }}</textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top:15px; width:100%;">
                    <i class="fas fa-save"></i> SAVE PROFILE
                </button>
            </form>
        </div>

        <!-- Tech Profile Card -->
        <div class="card">
            <h3><i class="fas fa-microchip"></i> Tech Fingerprint</h3>

            <div style="margin-top:15px;">
                <label style="color:var(--text-secondary); font-size:0.8rem;">CONFIDENCE SCORE</label>
                <div style="margin-top:5px;">
                    {% if lead.custom_fields_data.get('ai_identity') %}
                    <span class="badge badge-success">High (Verified)</span>
                    {% elif lead.holehe_data %}
                    <span class="badge badge-warning">Medium (OSINT)</span>
                    {% else %}
                    <span class="badge badge-danger">Low (Raw)</span>
                    {% endif %}
                </div>
            </div>

            <div style="margin-top:15px;">
                <label style="color:var(--text-secondary); font-size:0.8rem;">DETECTED HARDWARE</label>
                <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                    {% for cores in (timeline_visits | map(attribute='cpu_cores') | select | unique) %}
                    <span class="badge badge-blue"><i class="fas fa-microchip"></i> {{ cores }} Cores</span>
                    {% endfor %}

                    {% for ram in (timeline_visits | map(attribute='ram_gb') | select | unique) %}
                    <span class="badge badge-blue"><i class="fas fa-memory"></i> {{ ram }} GB</span>
                    {% endfor %}

                    {% for batt in (timeline_visits | map(attribute='battery_level') | select | unique) %}
                    <span class="badge badge-purple"><i class="fas fa-battery-half"></i> {{ batt }}</span>
                    {% endfor %}

                    {% if not (timeline_visits | map(attribute='cpu_cores') | select | list) %}
                    <span style="color:var(--text-secondary); font-size:0.85rem;">No hardware data</span>
                    {% endif %}
                </div>
            </div>

            <div style="margin-top:15px;">
                <label style="color:var(--text-secondary); font-size:0.8rem;">HOSTNAMES</label>
                <div style="font-family:monospace; font-size:0.8rem; margin-top:5px; word-break:break-all;">
                    {% for host in (timeline_visits | map(attribute='hostname') | select | unique) %}
                    <div style="margin-bottom:2px;"><i class="fas fa-network-wired text-success"></i> {{ host }}</div>
                    {% else %}
                    <span style="color:var(--text-secondary);">None</span>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>

    <!-- Right Column: Graph & Timeline -->
    <div style="display:flex; flex-direction:column; gap:20px;">

        <!-- Graph -->
        <div class="card" style="padding:0; overflow:hidden;">
            <div style="padding:15px; border-bottom:1px solid var(--border-subtle); background:var(--bg-panel);">
                <h3 style="margin:0;"><i class="fas fa-project-diagram"></i> Connection Graph</h3>
            </div>
            <div id="network" style="border:none; border-radius:0;"></div>
        </div>

        <!-- Timeline -->
        <div class="card">
            <h3><i class="fas fa-history"></i> Activity Timeline</h3>
            <div style="max-height: 400px; overflow-y: auto; margin-top:15px; padding-right:10px;">
                {% for v in timeline_visits %}
                <div style="display:flex; gap:15px; margin-bottom:20px; position:relative;">
                    <!-- Timeline Line -->
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <div
                            style="width:12px; height:12px; border-radius:50%; background:var(--accent-primary); z-index:2;">
                        </div>
                        {% if not loop.last %}
                        <div
                            style="width:2px; height:100%; background:var(--border-subtle); position:absolute; top:12px; left:5px; z-index:1;">
                        </div>
                        {% endif %}
                    </div>

                    <div style="flex:1; padding-bottom:5px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-size:0.9rem; font-weight:600; color:var(--text-primary);">
                                Visited <a href="/dashboard/stats/{{ v.link.slug }}" class="text-accent">/{{ v.link.slug
                                    }}</a>
                            </span>
                            <span style="font-size:0.8rem; color:var(--text-secondary);">{{
                                v.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>

                        <div
                            style="background:var(--bg-input); padding:10px; border-radius:8px; font-size:0.85rem; border:1px solid var(--border-subtle);">
                            <div style="display:flex; justify-content:space-between;">
                                <span><i class="fas fa-map-marker-alt text-danger"></i> {{ v.city or 'Unknown' }}, {{
                                    v.country or '' }}</span>
                                <span><i class="fas fa-desktop text-blue"></i> {{ v.device_type }}</span>
                            </div>
                            <div style="margin-top:5px; font-family:monospace; color:var(--text-secondary);">
                                IP: {{ v.ip_address }} {% if v.is_vpn %}<span class="badge badge-danger">VPN</span>{%
                                endif %}
                            </div>
                            {% if v.org %}
                            <div style="margin-top:5px; color:var(--accent-success);">
                                <i class="fas fa-building"></i> {{ v.org }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div style="text-align:center; padding:20px; color:var(--text-secondary);">No activity recorded.</div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Check if vis loaded
        if (typeof vis === 'undefined') {
            console.error("Vis.js not loaded!");
            document.getElementById('network').innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-danger);">Error: Graph library failed to load.<br>Check internet connection or AdBlock.</div>';
            return;
        }

        // Prepare nodes/edges
        var nodes = new vis.DataSet([]);
        var edges = new vis.DataSet([]);
        var existIds = new Set();

        // Lead Node
        nodes.add({ id: 0, label: "{{ lead.email }}", color: '#fbbf24', shape: 'star', size: 40, font: { color: '#fff', face: 'Inter' } });
        existIds.add(0);

        function addNode(id, label, color, shape, fromId) {
            if (!existIds.has(id)) {
                nodes.add({ id: id, label: label, color: color, shape: shape || 'dot', font: { color: '#fff' } });
                edges.add({ from: fromId || 0, to: id, color: { color: 'rgba(255,255,255,0.2)' } });
                existIds.add(id);
            }
        }

        // Add Data Points
        {% for v in visits %}
        // Group by Visit? No, flat graph is better for now.
        // Device
        var dev = "{{ v.os_family }} {{ v.device_type }}";
        if (dev.trim()) addNode(dev, dev, '#3b82f6', 'box');

        // IP
        var ip = "{{ v.ip_address }}";
        if (ip) addNode(ip, ip, '#ef4444', 'diamond');

        // Location
        var loc = "{{ v.city or '' }} {{ v.country or '' }}".trim();
        if (loc) addNode('loc_' + loc, 'üìç ' + loc, '#9b59b6', 'triangle');
        {% endfor %}

        // OSINT Sites
        {% for site in lead.holehe_sites %}
        addNode("site_" + site.domain, site.domain, '#10b981', 'hexagon');
        {% endfor %}

        // Create Network
        var container = document.getElementById('network');
        var data = { nodes: nodes, edges: edges };
        var options = {
            nodes: {
                borderWidth: 1,
                borderWidthSelected: 2,
                shadow: true
            },
            edges: {
                width: 1,
                smooth: { type: 'continuous' }
            },
            physics: {
                stabilization: true,
                barnesHut: {
                    gravitationalConstant: -3000,
                    springConstant: 0.04,
                    springLength: 95
                }
            },
            interaction: {
                hover: true,
                zoomView: true
            },
            layout: {
                randomSeed: 2
            }
        };

        var network = new vis.Network(container, data, options);

        // Fit after load
        network.once("stabilizationIterationsDone", function () {
            network.fit();
        });
    });
</script>
{% endblock %}