{% extends "base.html" %}

{% block head %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
    #network {
        width: 100%;
        height: 500px;
        background: rgba(0, 0, 0, 0.3);
        border: var(--border);
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2><i class="fas fa-user-secret"></i> Profile: <span class="text-accent">{{ lead.email }}</span></h2>
    <a href="/dashboard/contacts" class="btn-outline">Back</a>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">

    <!-- Left: Info -->
    <div class="card">
        <h3>Details</h3>
        <form method="POST">
            <div class="form-group">
                <label>Name / Alias</label>
                <input type="text" name="name" value="{{ lead.name or '' }}" placeholder="Unknown">
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Notes</label>
                <textarea name="notes"
                    style="width:100%; background:rgba(0,0,0,0.3); color:white; border:var(--border); border-radius:6px; padding:10px; min-height:100px;">{{ lead.notes or '' }}</textarea>
            </div>

            <button type="submit" class="btn" style="margin-top:10px;">SAVE NOTES</button>
        </form>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <h4>OSINT Status: <span id="status-badge" class="badge bg-secondary">{{ lead.scan_status|default('idle')|upper
                }}</span></h4>

        <div id="scan-results" style="margin-top:10px;">
            {% if holehe_list %}
            {% for site in holehe_list %}
            <span class="badge badge-green" style="margin-right:5px; margin-bottom:5px; display:inline-block;">{{ site
                }}</span>
            {% endfor %}
            {% endif %}
        </div>

        <form action="/dashboard/analyze_email" method="POST" style="margin-top:15px;">
            <input type="hidden" name="email" value="{{ lead.email }}">
            {% if lead.scan_status == 'pending' %}
            <button type="button" class="btn-outline" disabled style="width:100%; cursor:not-allowed;">
                <i class="fas fa-spinner fa-spin"></i> SCANNING...
            </button>
            {% else %}
            <button type="submit" class="btn-outline" style="width:100%;">
                <i class="fas fa-satellite-dish"></i> RUN DEEP SCAN
            </button>
            {% endif %}
        </form>

        <script>
            const leadId = {{ lead.id }};
            const currentStatus = "{{ lead.scan_status }}";
            const resultsDiv = document.getElementById('scan-results');
            const statusBadge = document.getElementById('status-badge');

            if (currentStatus === 'pending') {
                statusBadge.className = 'badge badge-yellow'; // Create check for yellow/orange
                statusBadge.style.background = 'rgba(255, 204, 0, 0.2)';
                statusBadge.style.color = '#ffcc00';

                const poller = setInterval(() => {
                    fetch(`/api/lead/${leadId}/status`)
                        .then(r => r.json())
                        .then(data => {
                            statusBadge.innerText = data.status.toUpperCase();

                            if (data.status === 'completed') {
                                clearInterval(poller);
                                statusBadge.style.background = 'rgba(0, 255, 157, 0.2)';
                                statusBadge.style.color = '#00ff9d';
                                statusBadge.className = 'badge badge-green';

                                // Render Results
                                try {
                                    const sites = JSON.parse(data.sites);
                                    resultsDiv.innerHTML = sites.map(s =>
                                        `<span class="badge badge-green" style="margin-right:5px; margin-bottom:5px; display:inline-block;">${s}</span>`
                                    ).join('');
                                    // Refresh page to update graph
                                    setTimeout(() => location.reload(), 1000);
                                } catch (e) { }
                            } else if (data.status === 'failed') {
                                clearInterval(poller);
                                statusBadge.innerText = 'FAILED';
                                statusBadge.style.color = 'red';
                            }
                        });
                }, 2000);
            }
        </script>
    </div>

    <!-- Right: Graph -->
    <div class="card">
        <h3>Intelligence Graph</h3>
        <div id="network"></div>
    </div>
</div>

<script type="text/javascript">
    // Data Nodes
    var nodes = new vis.DataSet([
        { id: 1, label: '{{ lead.email }}', color: '#00ff9d', shape: 'box', font: { color: 'black' } }
    ]);

    // Edges
    var edges = new vis.DataSet([]);

    var nodeId = 2;

    // Add Socials
    {% for site in holehe_list %}
    nodes.add({ id: nodeId, label: '{{ site }}', color: '#00ccff', shape: 'ellipse' });
    edges.add({ from: 1, to: nodeId });
    nodeId++;
    {% endfor %}

    // Add Hardware (from Visits - passed via template)
    {% for dev in devices %}
    nodes.add({ id: nodeId, label: '{{ dev }}', color: '#ffcc00', shape: 'diamond' });
    edges.add({ from: 1, to: nodeId });
    nodeId++;
    {% endfor %}

    var container = document.getElementById('network');
    var data = { nodes: nodes, edges: edges };
    var options = {
        nodes: {
            borderWidth: 2,
            shadow: true
        },
        physics: {
            stabilization: false,
            barnesHut: {
                gravitationalConstant: -2000,
                springLength: 150
            }
        }
    };
    var network = new vis.Network(container, data, options);
</script>

{% endblock %}