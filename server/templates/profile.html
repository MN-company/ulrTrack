{% extends "base.html" %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/vis-network.min.js"></script>
<style>
    #network {
        width: 100%;
        height: 500px;
        background: rgba(0, 0, 0, 0.3);
        border: var(--border);
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div style="display:flex; align-items:center; gap:15px;">
    <img src="https://www.gravatar.com/avatar/{{ lead.email | md5 }}?d=mp&s=64"
        style="border-radius:50%; border:2px solid var(--accent); width:50px; height:50px;">
    <h2><i class="fas fa-user-secret"></i> Profile: <span class="text-accent">{{ lead.email }}</span></h2>
</div>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">

    <!-- Left: Info -->
    <div class="card">
        <h3>Details</h3>
        <form method="POST">

            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label>Name / Alias</label>
                <input type="text" name="name" value="{{ lead.name or '' }}" placeholder="Unknown">
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Tags (comma separated)</label>
                <input type="text" name="tags" value="{{ lead.tags or '' }}" placeholder="e.g. vip, suspect, new">
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Notes</label>
                <textarea name="notes"
                    style="width:100%; background:rgba(0,0,0,0.3); color:white; border:var(--border); border-radius:6px; padding:10px; min-height:100px;">{{ lead.notes or '' }}</textarea>
            </div>

            <button type="submit" class="btn" style="margin-top:10px;">SAVE PROFILE</button>
        </form>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec); font-size:0.8rem;">DETECTED SCREENS:</span>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                {% for screen in (timeline_visits | map(attribute='screen_res') | select | unique) %}
                <span class="badge badge-gray"><i class="fas fa-desktop"></i> {{ screen }}</span>
                {% else %}
                <span style="color:var(--text-sec); font-size:0.8rem;">None</span>
                {% endfor %}
            </div>
        </div>

        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec); font-size:0.8rem;">TIMEZONES:</span>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                {% for tz in (timeline_visits | map(attribute='timezone') | select | unique) %}
                <span class="badge badge-gray"><i class="fas fa-clock"></i> {{ tz }}</span>
                {% else %}
                <span style="color:var(--text-sec); font-size:0.8rem;">None</span>
                {% endfor %}
            </div>
        </div>

        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec); font-size:0.8rem;">LANGUAGES:</span>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                {% for lang in (timeline_visits | map(attribute='browser_language') | select | unique) %}
                <span class="badge badge-gray"><i class="fas fa-language"></i> {{ lang }}</span>
                {% else %}
                <span style="color:var(--text-sec); font-size:0.8rem;">None</span>
                {% endfor %}
            </div>
        </div>

        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec); font-size:0.8rem;">HARDWARE:</span>
            <div style="display:flex; flex-direction: column; gap:5px; margin-top:5px;">
                <!-- CPU -->
                {% for cores in (timeline_visits | map(attribute='cpu_cores') | select | unique) %}
                <span class="badge badge-blue"><i class="fas fa-microchip"></i> CPU: {{ cores }} Cores</span>
                {% endfor %}

                <!-- RAM -->
                {% for ram in (timeline_visits | map(attribute='ram_gb') | select | unique) %}
                <span class="badge badge-blue"><i class="fas fa-memory"></i> RAM: {{ ram }} GB</span>
                {% endfor %}

                <!-- Battery -->
                {% for batt in (timeline_visits | map(attribute='battery_level') | select | unique) %}
                <span class="badge badge-purple"><i class="fas fa-battery-half"></i> Battery: {{ batt }}</span>
                {% endfor %}
            </div>
        </div>

        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec); font-size:0.8rem;">HOSTNAMES (Reverse DNS):</span>
            <div
                style="display:flex; flex-direction: column; gap:5px; margin-top:5px; font-family: monospace; font-size: 0.75rem;">
                {% for host in (timeline_visits | map(attribute='hostname') | select | unique) %}
                <div style="color: var(--text-primary); word-break: break-all;">
                    <i class="fas fa-network-wired text-accent"></i> {{ host }}
                </div>
                {% else %}
                <span style="color:var(--text-sec); font-size:0.8rem;">None</span>
                {% endfor %}
            </div>
        </div>



        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <h3>Activity Timeline</h3>
        <div
            style="max-height: 300px; overflow-y: auto; font-size: 0.85rem; border-left: 2px solid var(--border); padding-left: 15px;">
            {% for v in timeline_visits %}
            <div style="margin-bottom: 15px; position: relative;">
                <div
                    style="position: absolute; left: -21px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: var(--accent);">
                </div>
                <div style="color: var(--text-sec); font-size: 0.75rem;">{{ v.timestamp.strftime('%Y-%m-%d %H:%M') }}
                </div>
                <div>
                    Visited <a href="/dashboard/stats/{{ v.link.slug }}" class="text-accent">/{{ v.link.slug }}</a>
                </div>
                <div style="color: var(--text-sec);">
                    IP: {{ v.ip_address }} | Device: {{ v.device_type }}
                    {% if v.org %}
                    <br><span style="color: #4CAF50;"><i class="fas fa-building"></i> {{ v.org }}</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div style="color: var(--text-sec); font-style: italic;">No activity recorded for this contact.</div>
            {% endfor %}
        </div>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">



        <script id="server-data" type="application/json">
            {
                "lead": {
                    "id": {{ lead.id | tojson }},
                    "scan_status": {{ lead.scan_status | tojson }},
                    "email": {{ lead.email | tojson }},
                    "name": {{ (lead.name or '') | tojson }},
                    "tags": {{ (lead.tags or '') | tojson }}
                },
                "devices": {{ devices | default([]) | tojson }},
                "ips": {{ ips | default([]) | tojson }},
                "canvas_hashes": {{ canvas_hashes | default([]) | tojson }},
                "countries": {{ (timeline_visits | map(attribute='country') | select | list | unique | list) | default([]) | tojson }},
                "orgs": {{ (timeline_visits | map(attribute='org') | select | list | unique | list) | default([]) | tojson }},
                "related_leads": {{ (related_leads | map(attribute='email') | list) | tojson }}
            }
        </script>

    </div>

    <!-- Right: Graph -->
    <div class="card">
        <h3>Intelligence Graph</h3>
        <div id="network"></div>
    </div>
</div>

<script type="text/javascript">
    const serverDataGraph = JSON.parse(document.getElementById('server-data').textContent);

    if (typeof vis === 'undefined') {
        document.getElementById('network').innerHTML = '<div style="padding:20px; text-align:center; color:gray;">Graph library could not load (Check connection/AdBlock).</div>';
    } else {
        // Central node (Email + Name if available)
        const centerLabel = serverDataGraph.lead.name
            ? `${serverDataGraph.lead.name}\n${serverDataGraph.lead.email}`
            : serverDataGraph.lead.email;

        var nodes = new vis.DataSet([
            { id: 1, label: centerLabel, color: '#00ff9d', shape: 'box', font: { color: 'black', multi: true } }
        ]);
        var edges = new vis.DataSet([]);
        var nodeId = 2;

        // Helper to add node
        function addNode(label, color, shape, group) {
            nodes.add({ id: nodeId, label: label, color: color, shape: shape, group: group });
            edges.add({ from: 1, to: nodeId });
            nodeId++;
        }

        // Devices
        serverDataGraph.devices.forEach(dev => {
            addNode('ðŸ“± ' + dev, '#ffcc00', 'diamond', 'device');
        });

        // IPs
        serverDataGraph.ips.forEach(ip => {
            addNode('ðŸŒ ' + ip, '#ff6b6b', 'dot', 'ip');
        });

        // Countries
        serverDataGraph.countries.forEach(country => {
            if (country) addNode('ðŸ³ï¸ ' + country, '#9b59b6', 'triangle', 'location');
        });

        // Organizations
        serverDataGraph.orgs.forEach(org => {
            if (org) addNode('ðŸ¢ ' + org, '#3498db', 'box', 'org');
        });

        // Canvas Fingerprints
        serverDataGraph.canvas_hashes.forEach(hash => {
            addNode('ðŸ”’ #' + hash.slice(0, 8), '#e74c3c', 'hexagon', 'fingerprint');
        });

        // Related Leads (same device)
        serverDataGraph.related_leads.forEach(email => {
            if (email !== serverDataGraph.lead.email) {
                addNode('ðŸ‘¤ ' + email, '#2ecc71', 'star', 'related');
            }
        });



        var container = document.getElementById('network');
        var data = { nodes: nodes, edges: edges };
        var options = {
            nodes: {
                borderWidth: 2,
                shadow: true,
                font: { size: 12, color: '#ffffff' }
            },
            edges: {
                color: { color: 'rgba(255,255,255,0.3)' },
                width: 1
            },
            physics: {
                stabilization: { iterations: 100 },
                barnesHut: {
                    gravitationalConstant: -3000,
                    springLength: 120,
                    springConstant: 0.04
                }
            },
            groups: {
                social: { color: '#00ccff' },
                device: { color: '#ffcc00' },
                ip: { color: '#ff6b6b' },
                location: { color: '#9b59b6' },
                org: { color: '#3498db' },
                fingerprint: { color: '#e74c3c' },
                related: { color: '#2ecc71' },
                gaia: { color: '#f39c12' }
            }
        };
        var network = new vis.Network(container, data, options);
    }
</script>

{% endblock %}