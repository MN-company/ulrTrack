{% extends "base.html" %}

{% block head %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
    #network {
        width: 100%;
        height: 500px;
        background: rgba(0, 0, 0, 0.3);
        border: var(--border);
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div style="display:flex; align-items:center; gap:15px;">
    <img src="https://www.gravatar.com/avatar/{{ lead.email | md5 }}?d=mp&s=64"
        style="border-radius:50%; border:2px solid var(--accent); width:50px; height:50px;">
    <h2><i class="fas fa-user-secret"></i> Profile: <span class="text-accent">{{ lead.email }}</span></h2>
</div>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">

    <!-- Left: Info -->
    <div class="card">
        <h3>Details</h3>
        <form method="POST">

            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label>Name / Alias</label>
                <input type="text" name="name" value="{{ lead.name or '' }}" placeholder="Unknown">
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Tags (comma separated)</label>
                <input type="text" name="tags" value="{{ lead.tags or '' }}" placeholder="e.g. vip, suspect, new">
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Notes</label>
                <textarea name="notes"
                    style="width:100%; background:rgba(0,0,0,0.3); color:white; border:var(--border); border-radius:6px; padding:10px; min-height:100px;">{{ lead.notes or '' }}</textarea>
            </div>

            <button type="submit" class="btn" style="margin-top:10px;">SAVE PROFILE</button>
        </form>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec); font-size:0.8rem;">DETECTED SCREENS:</span>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                {% for screen in (timeline_visits | map(attribute='screen_res') | select | unique) %}
                <span class="badge badge-gray"><i class="fas fa-desktop"></i> {{ screen }}</span>
                {% else %}
                <span style="color:var(--text-sec); font-size:0.8rem;">None</span>
                {% endfor %}
            </div>
        </div>

        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec); font-size:0.8rem;">TIMEZONES:</span>
            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                {% for tz in (timeline_visits | map(attribute='timezone') | select | unique) %}
                <span class="badge badge-gray"><i class="fas fa-clock"></i> {{ tz }}</span>
                {% else %}
                <span style="color:var(--text-sec); font-size:0.8rem;">None</span>
                {% endfor %}
            </div>
        </div>

        <!-- V31: AI OSINT Intelligence -->
        <h3><i class="fas fa-brain"></i> AI Intelligence</h3>

        {% if ai_identity %}
        <div
            style="background: rgba(0,255,157,0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <div style="font-size: 0.8rem; color: var(--accent); margin-bottom: 5px;">AI IDENTITY INFERENCE</div>
            <div style="font-size: 0.9rem;" class="markdown-body">{{ ai_identity | markdown | safe }}</div>
        </div>
        {% else %}
        <form action="/dashboard/analyze_identity/{{ lead.id }}" method="POST" style="margin-bottom:15px;">

            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-outline btn-sm"><i class="fas fa-robot"></i> Run AI Identity
                Analysis</button>
        </form>
        {% endif %}

        {% if gaia_id %}
        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec);">Gaia ID:</span>
            <span class="mono text-accent">{{ gaia_id }}</span>
        </div>
        {% endif %}

        {% if permutations.full_names %}
        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec);">Possible Names:</span>
            {% for name in permutations.full_names %}
            <span class="badge badge-gray">{{ name }}</span>
            {% endfor %}
        </div>
        {% endif %}

        {% if permutations.company %}
        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec);">Company:</span>
            <span class="badge badge-green">{{ permutations.company }}</span>
        </div>
        {% endif %}

        {% if gravatar_data %}
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 0.8rem; color: var(--text-sec); margin-bottom: 5px;">GRAVATAR PROFILE</div>
            {% if gravatar_data.displayName %}
            <div><strong>Name:</strong> {{ gravatar_data.displayName }}</div>
            {% endif %}
            {% if gravatar_data.accounts %}
            <div style="margin-top: 5px;">
                <strong>Linked Accounts:</strong>
                {% for acc in gravatar_data.accounts %}
                <a href="{{ acc.url }}" target="_blank" style="color: var(--accent);">{{ acc.name }}</a>{% if not
                loop.last %}, {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <h3>Activity Timeline</h3>
        <div
            style="max-height: 300px; overflow-y: auto; font-size: 0.85rem; border-left: 2px solid var(--border); padding-left: 15px;">
            {% for v in timeline_visits %}
            <div style="margin-bottom: 15px; position: relative;">
                <div
                    style="position: absolute; left: -21px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: var(--accent);">
                </div>
                <div style="color: var(--text-sec); font-size: 0.75rem;">{{ v.timestamp.strftime('%Y-%m-%d %H:%M') }}
                </div>
                <div>
                    Visited <a href="/dashboard/stats/{{ v.link.slug }}" class="text-accent">/{{ v.link.slug }}</a>
                </div>
                <div style="color: var(--text-sec);">
                    IP: {{ v.ip_address }} | Device: {{ v.device_type }}
                    {% if v.org %}
                    <br><span style="color: #4CAF50;"><i class="fas fa-building"></i> {{ v.org }}</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div style="color: var(--text-sec); font-style: italic;">No activity recorded for this contact.</div>
            {% endfor %}
        </div>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <h4>OSINT Status: <span id="status-badge" class="badge bg-secondary">{{ lead.scan_status|default('idle')|upper
                }}</span></h4>

        <div id="scan-results" style="margin-top:10px;">
            {% if holehe_list %}
            {% for site in holehe_list %}
            <span class="badge badge-green" style="margin-right:5px; margin-bottom:5px; display:inline-block;">{{ site
                }}</span>
            {% endfor %}
            {% endif %}
        </div>

        {% if blackbird_data %}
        <div class="card"
            style="margin-top:15px; border: 1px solid rgba(114, 137, 218, 0.3); background: rgba(0,0,0,0.2);">
            <h5 style="color: #7289da; margin-bottom: 10px;"><i class="fab fa-discord"></i> Username Recon</h5>
            <div style="max-height: 150px; overflow-y: auto; font-size: 0.8rem; white-space: pre-wrap; color: #ccc;">{{
                blackbird_data }}</div>
        </div>
        {% endif %}

        <!-- Cloud Dorker -->
        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h5 style="color: var(--text-main); margin:0;"><i class="fas fa-search"></i> Cloud Dorker</h5>
                <form action="/dashboard/lead/{{ lead.id }}/dork" method="POST">

                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn-sm btn-outline"><i class="fas fa-robot"></i> AI Generate</button>
                </form>
            </div>

            {% if dorks %}
            <div
                style="margin-bottom:15px; padding:10px; background:rgba(0,255,100,0.05); border:1px solid rgba(0,255,100,0.2); border-radius:4px;">
                <h6 style="color:var(--accent); margin-bottom:5px;">AI Generated Dorks:</h6>
                <pre
                    style="font-size:0.75rem; color:#ccc; white-space:pre-wrap; font-family:var(--font-mono);">{{ dorks }}</pre>
            </div>
            {% endif %}

            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <a href="https://www.google.com/search?q=site:s3.amazonaws.com+OR+site:blob.core.windows.net+{{ lead.email | urlencode }}"
                    target="_blank" class="badge badge-gray" style="text-decoration: none; cursor: pointer;">
                    <i class="fab fa-aws"></i> Buckets
                </a>
                <a href="https://www.google.com/search?q=site:docs.google.com+OR+site:drive.google.com+{{ lead.email | urlencode }}"
                    target="_blank" class="badge badge-gray" style="text-decoration: none; cursor: pointer;">
                    <i class="fab fa-google-drive"></i> Docs
                </a>
                <a href="https://www.google.com/search?q=site:pastebin.com+OR+site:ghostbin.com+{{ lead.email | urlencode }}"
                    target="_blank" class="badge badge-gray" style="text-decoration: none; cursor: pointer;">
                    <i class="fas fa-paste"></i> Pastebin
                </a>
                <a href="https://www.google.com/search?q=site:trello.com+OR+site:atlassian.net+{{ lead.email | urlencode }}"
                    target="_blank" class="badge badge-gray" style="text-decoration: none; cursor: pointer;">
                    <i class="fab fa-trello"></i> PM Tools
                </a>
            </div>
        </div>

        <form action="/dashboard/analyze_email" method="POST" style="margin-top:15px;">


            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="email" value="{{ lead.email }}">
            {% if lead.scan_status == 'pending' %}
            <button type="button" class="btn-outline" disabled style="width:100%; cursor:not-allowed;">
                <i class="fas fa-spinner fa-spin"></i> SCANNING...
            </button>
            {% else %}
            <button type="submit" class="btn-outline" style="width:100%;">
                <i class="fas fa-satellite-dish"></i> RUN DEEP SCAN
            </button>
            {% endif %}
        </form>

        <script id="server-data" type="application/json">
            {
                "lead": {
                    "id": {{ lead.id | tojson }},
                    "scan_status": {{ lead.scan_status | tojson }},
                    "email": {{ lead.email | tojson }},
                    "name": {{ (lead.name or '') | tojson }},
                    "tags": {{ (lead.tags or '') | tojson }}
                },
                "holehe_list": {{ holehe_list | default([]) | tojson }},
                "devices": {{ devices | default([]) | tojson }},
                "ips": {{ ips | default([]) | tojson }},
                "canvas_hashes": {{ canvas_hashes | default([]) | tojson }},
                "countries": {{ (timeline_visits | map(attribute='country') | select | list | unique | list) | default([]) | tojson }},
                "orgs": {{ (timeline_visits | map(attribute='org') | select | list | unique | list) | default([]) | tojson }},
                "ai_identity": {{ (ai_identity or '') | tojson }},
                "gaia_id": {{ (gaia_id or '') | tojson }},
                "permutations": {{ permutations | default({}) | tojson }},
                "related_leads": [{% for rl in related_leads %}"{{ rl.email }}"{% if not loop.last %},{% endif %}{% endfor %}]
            }
        </script>
        <script>
            const serverData = JSON.parse(document.getElementById('server-data').textContent);
            const leadId = serverData.lead.id;
            const currentStatus = serverData.lead.scan_status;
            const resultsDiv = document.getElementById('scan-results');
            const statusBadge = document.getElementById('status-badge');

            if (currentStatus === 'pending') {
                statusBadge.className = 'badge badge-yellow'; // Create check for yellow/orange
                statusBadge.style.background = 'rgba(255, 204, 0, 0.2)';
                statusBadge.style.color = '#ffcc00';

                const poller = setInterval(() => {
                    fetch(`/api/lead/${leadId}/status`)
                        .then(r => r.json())
                        .then(data => {
                            statusBadge.innerText = data.status.toUpperCase();

                            if (data.status === 'completed') {
                                clearInterval(poller);
                                statusBadge.style.background = 'rgba(0, 255, 157, 0.2)';
                                statusBadge.style.color = '#00ff9d';
                                statusBadge.className = 'badge badge-green';

                                // Render Results
                                try {
                                    const sites = JSON.parse(data.sites);
                                    resultsDiv.innerHTML = sites.map(s =>
                                        `<span class="badge badge-green" style="margin-right:5px; margin-bottom:5px; display:inline-block;">${s}</span>`
                                    ).join('');
                                    // Refresh page to update graph
                                    setTimeout(() => location.reload(), 1000);
                                } catch (e) { }
                            } else if (data.status === 'failed') {
                                clearInterval(poller);
                                statusBadge.innerText = 'FAILED';
                                statusBadge.style.color = 'red';
                            }
                        });
                }, 2000);
            }
        </script>
    </div>

    <!-- Right: Graph -->
    <div class="card">
        <h3>Intelligence Graph</h3>
        <div id="network"></div>
    </div>
</div>

<script type="text/javascript">
    const serverDataGraph = JSON.parse(document.getElementById('server-data').textContent);

    // Central node (Email + Name if available)
    const centerLabel = serverDataGraph.lead.name
        ? `${serverDataGraph.lead.name}\n${serverDataGraph.lead.email}`
        : serverDataGraph.lead.email;

    var nodes = new vis.DataSet([
        { id: 1, label: centerLabel, color: '#00ff9d', shape: 'box', font: { color: 'black', multi: true } }
    ]);
    var edges = new vis.DataSet([]);
    var nodeId = 2;

    // Helper to add node
    function addNode(label, color, shape, group) {
        nodes.add({ id: nodeId, label: label, color: color, shape: shape, group: group });
        edges.add({ from: 1, to: nodeId });
        nodeId++;
    }

    // Social Accounts (holehe)
    serverDataGraph.holehe_list.forEach(site => {
        addNode('ðŸ”— ' + site, '#00ccff', 'ellipse', 'social');
    });

    // Devices
    serverDataGraph.devices.forEach(dev => {
        addNode('ðŸ“± ' + dev, '#ffcc00', 'diamond', 'device');
    });

    // IPs
    serverDataGraph.ips.forEach(ip => {
        addNode('ðŸŒ ' + ip, '#ff6b6b', 'dot', 'ip');
    });

    // Countries
    serverDataGraph.countries.forEach(country => {
        if (country) addNode('ðŸ³ï¸ ' + country, '#9b59b6', 'triangle', 'location');
    });

    // Organizations
    serverDataGraph.orgs.forEach(org => {
        if (org) addNode('ðŸ¢ ' + org, '#3498db', 'box', 'org');
    });

    // Canvas Fingerprints
    serverDataGraph.canvas_hashes.forEach(hash => {
        addNode('ðŸ”’ #' + hash.slice(0, 8), '#e74c3c', 'hexagon', 'fingerprint');
    });

    // Related Leads (same device)
    serverDataGraph.related_leads.forEach(email => {
        if (email !== serverDataGraph.lead.email) {
            addNode('ðŸ‘¤ ' + email, '#2ecc71', 'star', 'related');
        }
    });

    // Gaia ID
    if (serverDataGraph.gaia_id) {
        addNode('ðŸ†” Gaia: ' + serverDataGraph.gaia_id, '#f39c12', 'box', 'gaia');
    }

    var container = document.getElementById('network');
    var data = { nodes: nodes, edges: edges };
    var options = {
        nodes: {
            borderWidth: 2,
            shadow: true,
            font: { size: 12, color: '#ffffff' }
        },
        edges: {
            color: { color: 'rgba(255,255,255,0.3)' },
            width: 1
        },
        physics: {
            stabilization: { iterations: 100 },
            barnesHut: {
                gravitationalConstant: -3000,
                springLength: 120,
                springConstant: 0.04
            }
        },
        groups: {
            social: { color: '#00ccff' },
            device: { color: '#ffcc00' },
            ip: { color: '#ff6b6b' },
            location: { color: '#9b59b6' },
            org: { color: '#3498db' },
            fingerprint: { color: '#e74c3c' },
            related: { color: '#2ecc71' },
            gaia: { color: '#f39c12' }
        }
    };
    var network = new vis.Network(container, data, options);
</script>

{% endblock %}