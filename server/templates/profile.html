{% extends "base.html" %}

{% block head %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
    #network {
        width: 100%;
        height: 500px;
        background: rgba(0, 0, 0, 0.3);
        border: var(--border);
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div style="display:flex; align-items:center; gap:15px;">
        <img src="https://www.gravatar.com/avatar/{{ lead.email | md5 }}?d=mp&s=64"
            style="border-radius:50%; border:2px solid var(--accent); width:50px; height:50px;">
        <h2><i class="fas fa-user-secret"></i> Profile: <span class="text-accent">{{ lead.email }}</span></h2>
    </div>
    <a href="/dashboard/contacts" class="btn-outline">Back</a>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">

    <!-- Left: Info -->
    <div class="card">
        <h3>Details</h3>
        <form method="POST">
            <div class="form-group">
                <label>Name / Alias</label>
                <input type="text" name="name" value="{{ lead.name or '' }}" placeholder="Unknown">
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Tags (comma separated)</label>
                <input type="text" name="tags" value="{{ lead.tags or '' }}" placeholder="e.g. vip, suspect, new">
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Notes</label>
                <textarea name="notes"
                    style="width:100%; background:rgba(0,0,0,0.3); color:white; border:var(--border); border-radius:6px; padding:10px; min-height:100px;">{{ lead.notes or '' }}</textarea>
            </div>

            <button type="submit" class="btn" style="margin-top:10px;">SAVE PROFILE</button>
        </form>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <!-- V31: AI OSINT Intelligence -->
        <h3><i class="fas fa-brain"></i> AI Intelligence</h3>

        {% if ai_identity %}
        <div
            style="background: rgba(0,255,157,0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <div style="font-size: 0.8rem; color: var(--accent); margin-bottom: 5px;">AI IDENTITY INFERENCE</div>
            <div style="white-space: pre-line; font-size: 0.9rem;">{{ ai_identity }}</div>
        </div>
        {% else %}
        <form action="/dashboard/analyze_identity/{{ lead.id }}" method="POST" style="margin-bottom:15px;">
            <button type="submit" class="btn-outline btn-sm"><i class="fas fa-robot"></i> Run AI Identity
                Analysis</button>
        </form>
        {% endif %}

        {% if gaia_id %}
        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec);">Gaia ID:</span>
            <span class="mono text-accent">{{ gaia_id }}</span>
        </div>
        {% endif %}

        {% if permutations.full_names %}
        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec);">Possible Names:</span>
            {% for name in permutations.full_names %}
            <span class="badge badge-gray">{{ name }}</span>
            {% endfor %}
        </div>
        {% endif %}

        {% if permutations.company %}
        <div style="margin-bottom: 10px;">
            <span style="color: var(--text-sec);">Company:</span>
            <span class="badge badge-green">{{ permutations.company }}</span>
        </div>
        {% endif %}

        {% if gravatar_data %}
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 0.8rem; color: var(--text-sec); margin-bottom: 5px;">GRAVATAR PROFILE</div>
            {% if gravatar_data.displayName %}
            <div><strong>Name:</strong> {{ gravatar_data.displayName }}</div>
            {% endif %}
            {% if gravatar_data.accounts %}
            <div style="margin-top: 5px;">
                <strong>Linked Accounts:</strong>
                {% for acc in gravatar_data.accounts %}
                <a href="{{ acc.url }}" target="_blank" style="color: var(--accent);">{{ acc.name }}</a>{% if not
                loop.last %}, {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <h3>Activity Timeline</h3>
        <div
            style="max-height: 300px; overflow-y: auto; font-size: 0.85rem; border-left: 2px solid var(--border); padding-left: 15px;">
            {% for v in timeline_visits %}
            <div style="margin-bottom: 15px; position: relative;">
                <div
                    style="position: absolute; left: -21px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: var(--accent);">
                </div>
                <div style="color: var(--text-sec); font-size: 0.75rem;">{{ v.timestamp.strftime('%Y-%m-%d %H:%M') }}
                </div>
                <div>
                    Visited <a href="/dashboard/stats/{{ v.link.slug }}" class="text-accent">/{{ v.link.slug }}</a>
                </div>
                <div style="color: var(--text-sec);">
                    IP: {{ v.ip_address }} | Device: {{ v.device_type }}
                    {% if v.org %}
                    <br><span style="color: #4CAF50;"><i class="fas fa-building"></i> {{ v.org }}</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div style="color: var(--text-sec); font-style: italic;">No activity recorded for this contact.</div>
            {% endfor %}
        </div>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <h4>OSINT Status: <span id="status-badge" class="badge bg-secondary">{{ lead.scan_status|default('idle')|upper
                }}</span></h4>

        <div id="scan-results" style="margin-top:10px;">
            {% if holehe_list %}
            {% for site in holehe_list %}
            <span class="badge badge-green" style="margin-right:5px; margin-bottom:5px; display:inline-block;">{{ site
                }}</span>
            {% endfor %}
            {% endif %}
        </div>

        <form action="/dashboard/analyze_email" method="POST" style="margin-top:15px;">
            <input type="hidden" name="email" value="{{ lead.email }}">
            {% if lead.scan_status == 'pending' %}
            <button type="button" class="btn-outline" disabled style="width:100%; cursor:not-allowed;">
                <i class="fas fa-spinner fa-spin"></i> SCANNING...
            </button>
            {% else %}
            <button type="submit" class="btn-outline" style="width:100%;">
                <i class="fas fa-satellite-dish"></i> RUN DEEP SCAN
            </button>
            {% endif %}
        </form>

        <script id="server-data" type="application/json">
            {
                "lead": {
                    "id": {{ lead.id | tojson }},
                    "scan_status": {{ lead.scan_status | tojson }},
                    "email": {{ lead.email | tojson }}
                },
                "holehe_list": {{ holehe_list | default([]) | tojson }},
                "devices": {{ devices | default([]) | tojson }}
            }
        </script>
        <script>
            const serverData = JSON.parse(document.getElementById('server-data').textContent);
            const leadId = serverData.lead.id;
            const currentStatus = serverData.lead.scan_status;
            const resultsDiv = document.getElementById('scan-results');
            const statusBadge = document.getElementById('status-badge');

            if (currentStatus === 'pending') {
                statusBadge.className = 'badge badge-yellow'; // Create check for yellow/orange
                statusBadge.style.background = 'rgba(255, 204, 0, 0.2)';
                statusBadge.style.color = '#ffcc00';

                const poller = setInterval(() => {
                    fetch(`/api/lead/${leadId}/status`)
                        .then(r => r.json())
                        .then(data => {
                            statusBadge.innerText = data.status.toUpperCase();

                            if (data.status === 'completed') {
                                clearInterval(poller);
                                statusBadge.style.background = 'rgba(0, 255, 157, 0.2)';
                                statusBadge.style.color = '#00ff9d';
                                statusBadge.className = 'badge badge-green';

                                // Render Results
                                try {
                                    const sites = JSON.parse(data.sites);
                                    resultsDiv.innerHTML = sites.map(s =>
                                        `<span class="badge badge-green" style="margin-right:5px; margin-bottom:5px; display:inline-block;">${s}</span>`
                                    ).join('');
                                    // Refresh page to update graph
                                    setTimeout(() => location.reload(), 1000);
                                } catch (e) { }
                            } else if (data.status === 'failed') {
                                clearInterval(poller);
                                statusBadge.innerText = 'FAILED';
                                statusBadge.style.color = 'red';
                            }
                        });
                }, 2000);
            }
        </script>
    </div>

    <!-- Right: Graph -->
    <div class="card">
        <h3>Intelligence Graph</h3>
        <div id="network"></div>
    </div>
</div>

<script type="text/javascript">
    const serverDataGraph = JSON.parse(document.getElementById('server-data').textContent);
    // Data Nodes
    var nodes = new vis.DataSet([
        { id: 1, label: serverDataGraph.lead.email, color: '#00ff9d', shape: 'box', font: { color: 'black' } }
    ]);

    // Edges
    var edges = new vis.DataSet([]);

    var nodeId = 2;

    // Add Socials
    const holeheList = serverDataGraph.holehe_list;
    holeheList.forEach(site => {
        nodes.add({ id: nodeId, label: site, color: '#00ccff', shape: 'ellipse' });
        edges.add({ from: 1, to: nodeId });
        nodeId++;
    });

    // Add Hardware (from Visits - passed via template)
    const devices = serverDataGraph.devices;
    devices.forEach(dev => {
        nodes.add({ id: nodeId, label: dev, color: '#ffcc00', shape: 'diamond' });
        edges.add({ from: 1, to: nodeId });
        nodeId++;
    });

    var container = document.getElementById('network');
    var data = { nodes: nodes, edges: edges };
    var options = {
        nodes: {
            borderWidth: 2,
            shadow: true
        },
        physics: {
            stabilization: false,
            barnesHut: {
                gravitationalConstant: -2000,
                springLength: 150
            }
        }
    };
    var network = new vis.Network(container, data, options);
</script>

{% endblock %}