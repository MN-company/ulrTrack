{% extends "base.html" %}

{% block content %}
<h2 style="color: var(--accent); margin-bottom: 30px;">
    <i class="fas fa-shield-alt"></i> Security Settings
</h2>

<!-- 2FA Status Card -->
<div class="card">
    <h3 style="margin-bottom: 20px;">
        <i class="fas fa-mobile-alt"></i> Two-Factor Authentication
    </h3>

    {% if user.totp_enabled %}
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
        <span class="badge badge-green" style="font-size: 1rem; padding: 8px 16px;">
            <i class="fas fa-check-circle"></i> ENABLED
        </span>
        <span style="color: var(--text-sec);">
            Your account is protected with 2FA
        </span>
    </div>

    <p style="color: var(--text-sec); margin-bottom: 20px;">
        <i class="fas fa-life-ring"></i> You have <strong>{{ backup_count }}</strong> backup codes remaining
    </p>

    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <form method="POST" action="/dashboard/security/2fa/regenerate_backup" style="display: inline;">
            {{ csrf_token() }}
            <button type="submit" class="btn-outline btn-sm">
                <i class="fas fa-sync"></i> Regenerate Backup Codes
            </button>
        </form>

        <button onclick="showDisableConfirm()" class="btn-danger btn-sm">
            <i class="fas fa-times-circle"></i> Disable 2FA
        </button>
    </div>

    <!-- Disable Confirmation (hidden by default) -->
    <div id="disableConfirm"
        style="display: none; margin-top: 20px; padding: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 8px;">
        <p style="color: var(--danger); margin-bottom: 15px;">
            <strong><i class="fas fa-exclamation-triangle"></i> Are you sure?</strong><br>
            Disabling 2FA will make your account less secure.
        </p>
        <form method="POST" action="/dashboard/security/2fa/disable">
            {{ csrf_token() }}
            <div class="input-group" style="margin-bottom: 15px;">
                <label for="password">Enter your password to confirm:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn-danger">
                    <i class="fas fa-check"></i> Yes, Disable 2FA
                </button>
                <button type="button" onclick="hideDisableConfirm()" class="btn-outline">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    {% else %}
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
        <span class="badge badge-gray" style="font-size: 1rem; padding: 8px 16px;">
            <i class="fas fa-times-circle"></i> DISABLED
        </span>
        <span style="color: var(--text-sec);">
            2FA is not enabled
        </span>
    </div>

    <p style="color: var(--text-sec); margin-bottom: 20px;">
        Protect your account with an authenticator app (Google Authenticator, Authy, etc.)
    </p>

    <a href="/dashboard/security/2fa/setup" class="btn">
        <i class="fas fa-plus"></i> Enable 2FA
    </a>
    {% endif %}
</div>

<!-- Passkey Card -->
<div class="card">
    <h3 style="margin-bottom: 20px;">
        <i class="fas fa-fingerprint"></i> Passkey / Biometric Login
    </h3>

    {% if passkey_count > 0 %}
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
        <span class="badge badge-green" style="font-size: 1rem; padding: 8px 16px;">
            <i class="fas fa-check-circle"></i> {{ passkey_count }} REGISTERED
        </span>
    </div>

    <p style="color: var(--text-sec); margin-bottom: 20px;">
        You can login using your device's biometric authentication (fingerprint, Face ID) or security key.
    </p>

    <div id="passkeyList" style="margin-bottom: 20px;">
        <!-- Loaded via JavaScript -->
    </div>

    <button onclick="registerPasskey()" class="btn-outline btn-sm">
        <i class="fas fa-plus"></i> Add Another Passkey
    </button>

    {% else %}
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
        <span class="badge badge-gray" style="font-size: 1rem; padding: 8px 16px;">
            <i class="fas fa-times-circle"></i> NOT CONFIGURED
        </span>
    </div>

    <p style="color: var(--text-sec); margin-bottom: 20px;">
        Login faster and more securely using your device's biometric authentication (fingerprint, Face ID) or security
        key.
    </p>

    <button onclick="registerPasskey()" class="btn">
        <i class="fas fa-fingerprint"></i> Register Passkey
    </button>
    {% endif %}
</div>

<!-- Change Password Card -->
<div class="card">
    <h3 style="margin-bottom: 20px;">
        <i class="fas fa-key"></i> Change Password
    </h3>

    <p style="color: var(--text-sec); margin-bottom: 20px;">
        Update your admin password
    </p>

    <button onclick="alert('Password change feature coming soon!')" class="btn-outline">
        <i class="fas fa-edit"></i> Change Password
    </button>
</div>

<script>
    function showDisableConfirm() {
        document.getElementById('disableConfirm').style.display = 'block';
    }

    function hideDisableConfirm() {
        document.getElementById('disableConfirm').style.display = 'none';
    }

    // Load passkey list
    async function loadPasskeys() {
        try {
            const response = await fetch('/dashboard/passkey/list');
            const passkeys = await response.json();

            const container = document.getElementById('passkeyList');
            if (!container) return;

            container.innerHTML = passkeys.map((pk, idx) => `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 10px;">
                <div>
                    <div style="font-weight: 600;">
                        <i class="fas fa-key"></i> ${pk.name || 'Passkey ' + (idx + 1)}
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">
                        Registered: ${new Date(pk.created_at).toLocaleDateString()}
                    </div>
                </div>
                <button onclick="deletePasskey('${pk.id}')" class="btn-danger btn-sm">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `).join('');
        } catch (e) {
            console.error('Failed to load passkeys:', e);
        }
    }

    // Register new passkey
    async function registerPasskey() {
        try {
            // Check WebAuthn support
            if (!window.PublicKeyCredential) {
                alert('Your browser does not support passkeys. Please use Chrome, Safari, or Edge.');
                return;
            }

            const name = prompt('Name this passkey (e.g., "MacBook Pro", "iPhone"):');
            if (!name) return;

            // Get registration options from server
            const optionsResponse = await fetch('/dashboard/passkey/register/options', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!optionsResponse.ok) {
                throw new Error('Failed to get registration options');
            }

            const options = await optionsResponse.json();

            // Convert base64 to ArrayBuffer
            options.challenge = base64ToArrayBuffer(options.challenge);
            options.user.id = base64ToArrayBuffer(options.user.id);

            if (options.excludeCredentials) {
                options.excludeCredentials = options.excludeCredentials.map(cred => ({
                    ...cred,
                    id: base64ToArrayBuffer(cred.id)
                }));
            }

            // Create credential
            const credential = await navigator.credentials.create({
                publicKey: options
            });

            // Send to server for verification
            const verifyResponse = await fetch('/dashboard/passkey/register/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: credential.id,
                    rawId: arrayBufferToBase64(credential.rawId),
                    response: {
                        clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                        attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                    },
                    type: credential.type,
                    name: name
                })
            });

            const result = await verifyResponse.json();

            if (result.verified) {
                alert('✅ Passkey registered successfully!');
                location.reload();
            } else {
                alert('❌ Failed to register passkey: ' + (result.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Passkey registration error:', error);
            alert('❌ Passkey registration failed: ' + error.message);
        }
    }

    // Delete passkey
    async function deletePasskey(credentialId) {
        if (!confirm('Are you sure you want to delete this passkey?')) return;

        try {
            const response = await fetch(`/dashboard/passkey/delete/${credentialId}`, {
                method: 'POST'
            });

            if (response.ok) {
                loadPasskeys();
            } else {
                alert('Failed to delete passkey');
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }

    // Helper functions
    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // Load passkeys on page load
    if (document.getElementById('passkeyList')) {
        loadPasskeys();
    }
</script>

{% endblock %}